/* eslint-disable camelcase */
import { defineType } from '@sanity/types';
import { render } from '@testing-library/react';
import React, { useMemo } from 'react';
import { createMockSanityClient } from '../../../test/mocks/mockSanityClient';
import { createTestProvider } from '../../../test/testUtils/TestProvider';
import { createPatchChannel } from '../patch';
import { useFormState } from '../store/useFormState';
import { EMPTY_ARRAY } from '../utils/empty';
import { useWorkspace } from '../../studio';
import { StudioFormBuilder } from './StudioFormBuilder';
const schemaTypes = [defineType({
  type: 'document',
  name: 'test',
  title: 'Test',
  fields: [{
    type: 'string',
    name: 'title',
    title: 'Title'
  }]
})];
describe('StudioFormBuilder', () => {
  it('should render a studio form', async () => {
    const client = createMockSanityClient();
    const TestProvider = await createTestProvider({
      client,
      config: {
        name: 'default',
        projectId: 'test',
        dataset: 'test',
        schema: {
          types: schemaTypes
        }
      }
    });
    const focusPath = [];
    const openPath = [];
    const value = {
      _id: 'test',
      _type: 'test'
    };
    const onChange = jest.fn();
    const onFieldGroupSelect = jest.fn();
    const onPathBlur = jest.fn();
    const onPathFocus = jest.fn();
    const onPathOpen = jest.fn();
    const onSelectFieldGroup = jest.fn();
    const onSetFieldSetCollapsed = jest.fn();
    const onSetPathCollapsed = jest.fn();

    function TestForm() {
      const {
        schema
      } = useWorkspace();
      const schemaType = schema.get('test');

      if (!schemaType) {
        throw new Error('missing schema type');
      }

      if (schemaType.jsonType !== 'object') {
        throw new Error('schema type is not an object');
      }

      const patchChannel = useMemo(() => createPatchChannel(), []);
      const formState = useFormState(schemaType, {
        value,
        comparisonValue: value,
        focusPath,
        collapsedPaths: undefined,
        collapsedFieldSets: undefined,
        fieldGroupState: undefined,
        openPath,
        presence: [],
        validation: []
      });
      const formBuilderProps = useMemo(() => ({
        __internal_patchChannel: patchChannel,
        changesOpen: false,
        changed: false,
        collapsedFieldSets: undefined,
        collapsedPaths: undefined,
        focused: formState === null || formState === void 0 ? void 0 : formState.focused,
        focusPath: (formState === null || formState === void 0 ? void 0 : formState.focusPath) || EMPTY_ARRAY,
        groups: (formState === null || formState === void 0 ? void 0 : formState.groups) || EMPTY_ARRAY,
        id: (formState === null || formState === void 0 ? void 0 : formState.id) || '',
        level: (formState === null || formState === void 0 ? void 0 : formState.level) || 0,
        members: (formState === null || formState === void 0 ? void 0 : formState.members) || EMPTY_ARRAY,
        onChange,
        onFieldGroupSelect,
        onPathBlur,
        onPathFocus,
        onPathOpen,
        onSelectFieldGroup,
        onSetFieldSetCollapsed,
        onSetPathCollapsed,
        path: EMPTY_ARRAY,
        presence: EMPTY_ARRAY,
        schemaType: (formState === null || formState === void 0 ? void 0 : formState.schemaType) || schemaType,
        validation: EMPTY_ARRAY,
        value: formState === null || formState === void 0 ? void 0 : formState.value
      }), [formState, patchChannel, schemaType]);
      return /*#__PURE__*/React.createElement(StudioFormBuilder, formBuilderProps);
    }

    const result = render( /*#__PURE__*/React.createElement(TestProvider, null, /*#__PURE__*/React.createElement(TestForm, null)));
    const titleField = await result.findByTestId('field-title');
    expect(removeClasses(titleField.outerHTML)).toMatchSnapshot();
  });
});

function removeClasses(html) {
  return html.replace(/\s+class=".*?"/g, '');
}